<script type="text/babel">
    const { useState, useEffect } = React;
    
    function DailyOffice() {
        const [selectedDate, setSelectedDate] = useState('');
        const [timeOfDay, setTimeOfDay] = useState('morning');
        const [officeContent, setOfficeContent] = useState(null);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [devotionalFile, setDevotionalFile] = useState(null);
        const [officeFile, setOfficeFile] = useState(null);

        useEffect(() => {
            const now = new Date();
            const hours = now.getHours();
            const dateStr = now.toISOString().split('T')[0];
            
            setSelectedDate(dateStr);
            setTimeOfDay(hours >= 12 ? 'evening' : 'morning');
            
            loadFiles();
        }, []);

        const loadFiles = async () => {
            try {
                const [devotionalRes, officeRes] = await Promise.all([
                    fetch('devotional.txt'),
                    fetch('office.txt')
                ]);
                
                if (!devotionalRes.ok || !officeRes.ok) {
                    throw new Error('Failed to load files');
                }
                
                const devotionalText = await devotionalRes.text();
                const officeText = await officeRes.text();
                
                setDevotionalFile(devotionalText);
                setOfficeFile(officeText);
            } catch (err) {
                console.error('Error loading files:', err);
                setError('Failed to load content files. Please refresh the page.');
            }
        };

        const getDayOfWeek = (dateStr) => {
            const date = new Date(dateStr);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        };

        const parseOfficeSection = (content, sectionName, period) => {
            // Define all possible section headings to recognise the end of a section
            const sectionHeadings = ['Thanksgiving', 'Forgiveness', 'Meditation', 'Benediction'];
            const lines = content.split('\n');
            let inSection = false;
            let result = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // If we're already in our target section and hit another heading, stop.
                if (inSection && sectionHeadings.includes(line) && line !== sectionName) {
                    break;
                }

                if (line === sectionName) {
                    inSection = true;
                    continue;
                }
                
                if (inSection && line.startsWith(period.toUpperCase())) {
                    const prayerLine = line.substring(period.length + 3);
                    let verseLines = [];
                    
                    // Look ahead to gather the prayer text
                    for (let j = i + 1; j < lines.length; j++) {
                        const nextLine = lines[j].trim();
                        // Stop if we hit a blank line followed by another blank line, or the start of a new prayer
                        if (nextLine.startsWith('MORNING') || nextLine.startsWith('EVENING') || 
                            (nextLine === '' && lines[j+1]?.trim() === '')) {
                            break;
                        }
                        // Also stop if we hit the next main heading
                        if (sectionHeadings.includes(nextLine)) {
                            break;
                        }
                        if (nextLine) {
                            verseLines.push(nextLine);
                        }
                    }
                    
                    result.push({
                        title: prayerLine,
                        text: verseLines.join(' ').replace(/\(\s*cf\..*?\)/g, '').trim() // Strips verse numbers like (Psalm 51) etc.
                    });
                }
            }
            
            return result;
        };

        const parseDailyFocus = (content, dayName, period) => {
            const sectionName = `${dayName} Focus:`;
            const lines = content.split('\n');
            let inSection = false;
            let result = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith(sectionName)) {
                    inSection = true;
                    continue;
                }
                
                if (inSection && line.startsWith(period.toUpperCase())) {
                    const prayerLine = line.substring(period.length + 3);
                    let verseLines = [];
                    
                    for (let j = i + 1; j < lines.length; j++) {
                        const nextLine = lines[j].trim();
                        if (nextLine.startsWith('MORNING') || nextLine.startsWith('EVENING') || 
                            (nextLine === '' && lines[j+1]?.trim().includes('Focus:'))) {
                            break;
                        }
                        if (nextLine) {
                            verseLines.push(nextLine);
                        }
                    }
                    
                    const reference = verseLines.pop();
                    result.push({
                        title: prayerLine,
                        text: verseLines.join(' '),
                        reference: reference
                    });
                }
                
                if (inSection && line.includes('Focus:') && !line.startsWith(sectionName)) {
                    break;
                }
            }
            
            return result;
        };

        const parseDevotional = (content, monthName, day, period) => {
            const searchPattern = `${monthName} ${day} ${period}`;
            const lines = content.split('\n');
            let foundIndex = -1;
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim() === searchPattern) {
                    foundIndex = i;
                    break;
                }
            }
            
            if (foundIndex === -1) return null;
            
            let devotionalLines = [];
            const datePattern = /^(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d+\s+(AM|PM)$/;
            
            for (let i = foundIndex + 1; i < lines.length; i++) {
                if (datePattern.test(lines[i].trim())) break;
                devotionalLines.push(lines[i]);
            }
            
            const text = devotionalLines.join('\n').trim();
            const textLines = text.split('\n').filter(line => line.trim());
            return {
                title: textLines[0] || '',
                text: textLines.slice(1).join('\n\n')
            };
        };

        useEffect(() => {
            if (!selectedDate || !devotionalFile || !officeFile) return;

            setLoading(true);
            setError('');
            
            setTimeout(() => {
                try {
                    const date = new Date(selectedDate);
                    // Adjust for leap years in the devotional file, which lacks Feb 29
                    const isLeapYear = (year) => (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
                    
                    let month = date.getUTCMonth();
                    let day = date.getUTCDate();
                    
                    if (isLeapYear(date.getUTCFullYear()) && month === 1 && day === 29) {
                        day = 28;
                    }
                    
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                       'July', 'August', 'September', 'October', 'November', 'December'];
                    const monthName = monthNames[month];
                    const period = timeOfDay === 'morning' ? 'AM' : 'PM';
                    const dayName = getDayOfWeek(selectedDate);
                    
                    const thanksgiving = parseOfficeSection(officeFile, 'Thanksgiving', timeOfDay);
                    const forgiveness = parseOfficeSection(officeFile, 'Forgiveness', timeOfDay);
                    const meditation = parseOfficeSection(officeFile, 'Meditation', timeOfDay);
                    const benediction = parseOfficeSection(officeFile, 'Benediction', timeOfDay);
                    const dailyFocus = parseDailyFocus(officeFile, dayName, timeOfDay);
                    const devotional = parseDevotional(devotionalFile, monthName, day, period);
                    
                    if (!devotional) {
                        throw new Error(`Could not load devotional for ${monthName} ${day}.`);
                    }
                    
                    setOfficeContent({
                        thanksgiving,
                        forgiveness,
                        meditation,
                        devotional,
                        dailyFocus,
                        dayName,
                        benediction
                    });
                    
                } catch (err) {
                    setError('Unable to load Daily Office content. Please check the date and try again.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            }, 400);
        }, [selectedDate, timeOfDay, devotionalFile, officeFile]);

        const renderPrayer = (prayer) => (
            <div key={prayer.title} className="mb-6 fade-in">
                <h4 className="serif text-lg font-semibold text-blue-900 mb-3">{prayer.title}</h4>
                <div className="prayer-content text-gray-800">
                    <p className="whitespace-pre-line leading-relaxed">{prayer.text}</p>
                    {prayer.reference && <p className="verse-reference">{prayer.reference}</p>}
                </div>
            </div>
        );

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        const currentDate = selectedDate ? new Date(selectedDate) : null;
        const formattedDate = currentDate ? 
            `${monthNames[currentDate.getUTCMonth()]} ${currentDate.getUTCDate()}, ${currentDate.getUTCFullYear()}` : '';

        return (
            <div className="min-h-screen p-4 md:p-8 py-6 md:py-12">
                <div className="max-w-4xl mx-auto">
                    {/* Header */}
                    <div className="text-center mb-8">
                        <h1 className="serif text-5xl md:text-6xl font-bold text-blue-950 mb-3 tracking-tight">
                            Daily Office
                        </h1>
                        <div className="h-1 w-24 mx-auto bg-gradient-to-r from-transparent via-blue-700 to-transparent mb-3"></div>
                        <p className="text-blue-800 text-sm md:text-base tracking-wide uppercase font-medium">
                            Prayer & Devotion
                        </p>
                    </div>

                    {/* Controls */}
                    <div className="glass-effect rounded-2xl shadow-custom p-6 mb-6">
                        <div className="grid md:grid-cols-2 gap-5">
                            <div className="control-card">
                                <label className="block text-sm font-semibold text-blue-900 mb-3 tracking-wide">
                                    üìÖ DATE
                                </label>
                                <input
                                    type="date"
                                    value={selectedDate}
                                    onChange={(e) => setSelectedDate(e.target.value)}
                                    className="w-full px-4 py-3.5 text-base bg-white border-2 border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-blue-900 font-medium"
                                />
                            </div>

                            <div className="control-card">
                                <label className="block text-sm font-semibold text-blue-900 mb-3 tracking-wide">
                                    ‚è∞ TIME
                                </label>
                                <select
                                    value={timeOfDay}
                                    onChange={(e) => setTimeOfDay(e.target.value)}
                                    className="w-full px-4 py-3.5 text-base bg-white border-2 border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-blue-900 font-medium cursor-pointer"
                                >
                                    <option value="morning">Morning Office</option>
                                    <option value="evening">Evening Office</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    {loading && (
                        <div className="glass-effect rounded-2xl shadow-custom p-12 text-center">
                            <div className="loading-spinner rounded-full h-14 w-14 border-4 border-t-4 animate-spin mx-auto mb-4"></div>
                            <p className="text-blue-700 font-medium">Preparing your Daily Office...</p>
                        </div>
                    )}

                    {error && (
                        <div className="glass-effect rounded-2xl shadow-custom p-6">
                            <div className="bg-red-50 border-2 border-red-300 text-red-800 px-5 py-4 rounded-xl text-sm md:text-base font-medium">
                                {error}
                            </div>
                        </div>
                    )}

                    {!loading && !error && officeContent && (
                        <div className="glass-effect rounded-2xl shadow-custom p-6 md:p-10 fade-in">
                            <div className="text-center mb-8">
                                <h2 className="serif text-2xl md:text-3xl font-bold text-blue-950 mb-2">
                                    {timeOfDay === 'morning' ? 'Morning' : 'Evening'} Office
                                </h2>
                                <p className="text-blue-700 font-medium">{formattedDate}</p>
                            </div>

                            {/* Thanksgiving */}
                            {officeContent.thanksgiving.length > 0 && (
                                <div className="mb-8">
                                    <div className="section-header">
                                        üôè Thanksgiving
                                    </div>
                                    {officeContent.thanksgiving.map(renderPrayer)}
                                </div>
                            )}

                            <div className="section-divider"></div>

                            {/* Forgiveness */}
                            {officeContent.forgiveness.length > 0 && (
                                <div className="mb-8">
                                    <div className="section-header">
                                        ‚úùÔ∏è Forgiveness
                                    </div>
                                    {officeContent.forgiveness.map(renderPrayer)}
                                </div>
                            )}

                            <div className="section-divider"></div>

                            {/* Meditation */}
                            {officeContent.meditation.length > 0 && (
                                <div className="mb-8">
                                    <div className="section-header">
                                        üìñ Meditation
                                    </div>
                                    {officeContent.meditation.map(renderPrayer)}
                                </div>
                            )}

                            <div className="section-divider"></div>

                            {/* Spurgeon Devotional */}
                            <div className="mb-8">
                                <div className="section-header">
                                    üìö Spurgeon's Morning & Evening
                                </div>
                                <div className="fade-in">
                                    <h4 className="serif text-xl font-semibold text-blue-900 mb-3 italic">
                                        "{officeContent.devotional.title}"
                                    </h4>
                                    <div className="prayer-content text-gray-800">
                                        <p className="whitespace-pre-line leading-relaxed">
                                            {officeContent.devotional.text}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div className="section-divider"></div>

                            {/* Daily Focus */}
                            {officeContent.dailyFocus.length > 0 && (
                                <div className="mb-8">
                                    <div className="section-header">
                                        üéØ {officeContent.dayName} Focus
                                    </div>
                                    {officeContent.dailyFocus.map(renderPrayer)}
                                </div>
                            )}

                            <div className="section-divider"></div>

                            {/* Benediction */}
                            {officeContent.benediction.length > 0 && (
                                <div>
                                    <div className="section-header">
                                        üïäÔ∏è Benediction
                                    </div>
                                    {officeContent.benediction.map(renderPrayer)}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Footer */}
                    <div className="text-center mt-8 text-blue-800 text-xs md:text-sm space-y-1">
                        <p className="font-medium">A daily rhythm of prayer and Scripture</p>
                    </div>
                </div>
            </div>
        );
    }

    ReactDOM.render(<DailyOffice />, document.getElementById('root'));
</script>
